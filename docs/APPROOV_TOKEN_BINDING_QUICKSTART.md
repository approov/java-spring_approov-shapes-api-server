# Approov Token Binding Quickstart

This quickstart is for developers familiar with Java who are looking for a quick intro into how they can add [Approov](https://approov.io) into an existing project. Therefore this will guide you through the necessary steps for adding Approov with token binding to an existing Java Spring API server.

## TOC - Table of Contents

* [Why?](#why)
* [How it Works?](#how-it-works)
* [Requirements](#requirements)
* [Approov Setup](#approov-setup)
* [Approov Token Check](#approov-token-binding-check)
* [Try the Approov Integration Example](#try-the-approov-integration-example)


## Why?

To lock down your API server to your mobile app. Please read the brief summary in the [README](/README.md#why) at the root of this repo or visit our [website](https://approov.io/product.html) for more details.

[TOC](#toc---table-of-contents)


## How it works?

For more background, see the overview in the [README](/README.md#how-it-works) at the root of this repo.

The main functionality for the Approov token check is in the file [ApproovAuthentication.java](/servers/hello/src/approov-protected-server/token-binding-check/src/main/java/com/criticalblue/approov/jwt/authentication/ApproovAuthentication.java). Take a look at the `verifyApproovToken()` function to see the simple code for the check.

The Approov token binding check can be found in the file [ApproovTokenBindingAuthentication.java](/servers/hello/src/approov-protected-server/token-binding-check/src/main/java/com/criticalblue/approov/jwt/authentication/ApproovTokenBindingAuthentication.java). Take a look at the `verifyApproovTokenBinding()` function to see the simple code for the check.

[TOC](#toc---table-of-contents)


## Requirements

To complete this quickstart you will need both Java, Java Spring, and the Approov CLI tool installed.

* [OpenJDK](https://openjdk.java.net/install/)
* [Java Spring](https://docs.spring.io/spring-boot/docs/current/reference/html/getting-started.html#getting-started.installing)
* [Approov CLI](https://approov.io/docs/latest/approov-installation/#approov-tool) - Learn how to use it [here](https://approov.io/docs/latest/approov-cli-tool-reference/)

[TOC](#toc---table-of-contents)


## Approov Setup

To use Approov with the Java Spring API server we need a small amount of configuration. First, Approov needs to know the API domain that will be protected. Second, the Java Spring API server needs the Approov Base64 encoded secret that will be used to verify the tokens generated by the Approov cloud service.

### Configure API Domain

Approov needs to know the domain name of the API for which it will issue tokens.

Add it with:

```text
approov api -add your.api.domain.com
```

Adding the API domain also configures the [dynamic certificate pinning](https://approov.io/docs/latest/approov-usage-documentation/#approov-dynamic-pinning) setup, out of the box.

> **NOTE:** By default the pin is extracted from the public key of the leaf certificate served by the domain, as visible to the box issuing the Approov CLI command and the Approov servers.

### Approov Secret

Approov tokens are signed with a symmetric secret. To verify tokens, we need to grab the secret using the [Approov secret command](https://approov.io/docs/latest/approov-cli-tool-reference/#secret-command) and plug it into the Java Spring API server environment to check the signatures of the [Approov Tokens](https://www.approov.io/docs/latest/approov-usage-documentation/#approov-tokens) that it processes.

Retrieve the Approov secret with:

```text
approov secret -get base64
```

> **NOTE:** The `approov secret` command requires an [administration role](https://approov.io/docs/latest/approov-usage-documentation/#account-access-roles) to execute successfully.

#### Set the Approov Secret

Open the `.env` file and add the Approov secret to the var:

```text
APPROOV_BASE64_SECRET=approov_base64_secret_here
```

[TOC](#toc---table-of-contents)


## Approov Token Check

To check the Approov token we will use the [jwtk/jjwt](https://github.com/jwtk/jjwt) package.

Add to your `build.gradle` dependencies:

```gradle
dependencies {

    // omitted..

    implementation group: 'io.jsonwebtoken', name: 'jjwt-api', version: '0.11.2'
    runtimeOnly 'io.jsonwebtoken:jjwt-impl:0.11.2',
        'io.jsonwebtoken:jjwt-jackson:0.11.2'
}
```

### The Approov Package

From this repo add the package `com.criticalblue.approov.jwt.authentication` to your current project by copying the entire [authentication](/servers/hello/src/approov-protected-server/token-binding-check/src/main/java/com/criticalblue/approov/jwt/authentication) folder into your project.

Next, use it from the class in your project that extends the `WebSecurityConfigurerAdapter`. For example:

```java
package com.yourcompany.projectname;

import com.criticalblue.approov.jwt.authentication.*;
import org.springframework.core.annotation.Order;
import org.springframework.security.config.annotation.web.builders.WebSecurity;
import org.springframework.security.config.http.SessionCreationPolicy;
import org.springframework.web.cors.CorsConfiguration;
import org.springframework.web.cors.CorsConfigurationSource;
import org.springframework.web.cors.UrlBasedCorsConfigurationSource;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.http.HttpMethod;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;
import java.util.Arrays;

@Configuration
@EnableWebSecurity
public class WebSecurityConfig extends WebSecurityConfigurerAdapter {

    private static ApproovConfig approovConfig = ApproovConfig.getInstance();

    @Bean
    CorsConfigurationSource corsConfigurationSource() {
        CorsConfiguration configuration = new CorsConfiguration();
        configuration.setAllowedMethods(Arrays.asList("GET"));
        configuration.addAllowedHeader("Authorization");
        configuration.addAllowedHeader("Approov-Token");
        UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();
        source.registerCorsConfiguration("/**", configuration);
        return source;
    }

    @Override
    public void configure(WebSecurity web) throws Exception {
        web.ignoring().antMatchers("/error");
    }

    @Configuration
    // @IMPORTANT Approov token check must be at Order 1. Any other type of
    //            Authentication (User, API Key, etc.) for the request should go
    //            after this one with @Order(2).
    @Order(1)
    public static class ApproovWebSecurityConfig extends WebSecurityConfigurerAdapter {

        @Override
        protected void configure(HttpSecurity http) throws Exception {

            http.cors();

            http
                .httpBasic().disable()
                .formLogin().disable()
                .logout().disable()
                .csrf().disable()
                // @APPROOV The Approov Token check is triggered here.
                .authenticationProvider(new ApproovAuthenticationProvider(approovConfig))
                .sessionManagement().sessionCreationPolicy(SessionCreationPolicy.STATELESS);

            http
                .securityContext()
                // @APPROOV The Approov Token check is configured here.
                .securityContextRepository(new ApproovSecurityContextRepository(approovConfig))
                .and()
                    .exceptionHandling()
                    // @APPROOV The Approov Token check is done here
                    .authenticationEntryPoint(new ApproovAuthenticationEntryPoint())
                .and()
                    // @APPROOV This matcher will require the Approov token for
                    // all API endpoints.
                    .antMatcher("/")
                        .authorizeRequests()
                        .antMatchers(HttpMethod.GET, "/**").authenticated();
        }
    }
}
```

> **NOTE:** When the Approov token validation fails we return a `401` with an empty body, because we don't want to give clues to an attacker about the reason the request failed, and you can go even further by returning a `400`.

A full working example for a simple Hello World server can be found at [/servers/hello/src/approov-protected-server/token-binding-check](/servers/hello/src/approov-protected-server/token-binding-check).

To see the code difference between the token check and the token binding check on the Hello servers use the git diff command from the root of this repo:

```bash
git diff --no-index ./servers/hello/src/approov-protected-server/token-check/src/main/java/com/criticalblue/approov/jwt/ ./servers/hello/src/approov-protected-server/token-binding-check/src/main/java/com/criticalblue/approov/jwt/
```

[TOC](#toc---table-of-contents)


## Test your Approov Integration

The following examples below use cURL, but you can also use the [Postman Collection](/README.md#testing-with-postman) to make the API requests. Just remember that you need to adjust the urls and tokens defined in the collection to match your deployment. Alternatively, the above README also contains instructions for using the preset _dummy_ secret to test your Approov integration.

#### With Valid Approov Tokens

Generate a valid token example from the Approov Cloud service:

```
approov token -setDataHashInToken 'Bearer authorizationtoken' -genExample your.api.domain.com
```

Then make the request with the generated token:

```text
curl -i --request GET 'https://your.api.domain.com/v1/shapes' \
  --header 'Authorization: Bearer authorizationtoken' \
  --header 'Approov-Token: APPROOV_TOKEN_EXAMPLE_HERE'
```

The request should be accepted. For example:

```text
HTTP/1.1 200 OK

...

{"message": "Hello, World!"}
```

#### With Invalid Approov Tokens

##### No Authorization Token

Let's just remove the Authorization header from the request:

```text
curl -i --request GET 'https://your.api.domain.com/v1/shapes' \
  --header 'Approov-Token: APPROOV_TOKEN_EXAMPLE_HERE'
```

The above request should fail with an Unauthorized error. For example:

```text
HTTP/1.1 401 Unauthorized

...

{}
```

##### Same Approov Token with a Different Authorization Token

Make the request with the same generated token, but with another random authorization token:

```
curl -i --request GET 'https://your.api.domain.com/v1/shapes' \
  --header 'Authorization: Bearer anotherauthorizationtoken' \
  --header 'Approov-Token: APPROOV_TOKEN_EXAMPLE_HERE'
```

The above request should also fail with an Unauthorized error. For example:

```text
HTTP/1.1 401 Unauthorized

...

{}
```
